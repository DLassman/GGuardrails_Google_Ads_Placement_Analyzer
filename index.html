<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Ads Placement Analyzer</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #3498db; }
        .loader-spin { animation: spinner 1.5s linear infinite; }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback } = React;

        const PlacementAnalyzer = () => {
            const [file, setFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [analysis, setAnalysis] = useState(null);

            // Placement categories
            const PLACEMENT_CATEGORIES = {
                GAMBLING: { name: 'Gambling/Betting', risk: 'high' },
                CHILDREN: { name: "Children's Content", risk: 'high' },
                GAMES: { name: 'Games/Entertainment', risk: 'medium' },
                NEWS: { name: 'News/Media', risk: 'low' },
                EDUCATION: { name: 'Educational', risk: 'low' },
                BUSINESS: { name: 'Business/Professional', risk: 'low' },
                LIFESTYLE: { name: 'Lifestyle/Shopping', risk: 'low' },
                ADULT: { name: 'Adult/Dating', risk: 'high' },
                CRYPTO: { name: 'Cryptocurrency', risk: 'high' },
                FOREIGN: { name: 'Foreign Language', risk: 'medium' },
                SPAM: { name: 'Spam/Low Quality', risk: 'high' },
                TOOLS: { name: 'Tools/Utilities', risk: 'low' },
                YOUTUBE: { name: 'YouTube', risk: 'low' },
                UNKNOWN: { name: 'Unknown/Uncategorized', risk: 'medium' }
            };

            const analyzePlacement = (row) => {
                const placement = row['Placement'] || '';
                const placementUrl = row['Placement url'] || row['Placement URL'] || '';
                const type = row['Type'] || '';
                const impressions = Number(row['Impressions'] || row['Impr.'] || 0);
                const clicks = Number(row['Clicks'] || 0);
                const cost = Number(row['Cost'] || 0);
                const conversions = Number(row['Conversions'] || row['Conv.'] || 0);
                
                // Calculate metrics
                const ctr = impressions > 0 ? (clicks / impressions * 100) : 0;
                const convRate = clicks > 0 ? (conversions / clicks * 100) : 0;
                const cpa = conversions > 0 ? (cost / conversions) : 0;
                
                // Major platforms that should never be excluded entirely
                const majorPlatforms = [
                    'youtube.com', 'gmail.com', 'google.com', 'play.google.com',
                    'facebook.com', 'instagram.com', 'twitter.com', 'linkedin.com'
                ];
                
                const isMajorPlatform = majorPlatforms.some(platform => 
                    placementUrl.toLowerCase().includes(platform) && 
                    !placementUrl.includes('/watch') && 
                    !placementUrl.includes('/channel')
                );
                
                const isHighTraffic = impressions > 1000 || clicks > 50 || conversions > 5;
                
                // Categorize placement
                let category = PLACEMENT_CATEGORIES.UNKNOWN;
                const lowerUrl = placementUrl.toLowerCase();
                const lowerPlacement = placement.toLowerCase();
                
                if (lowerUrl.includes('youtube.com')) {
                    category = PLACEMENT_CATEGORIES.YOUTUBE;
                } else if (/casino|poker|bet|gambl|lottery|slots/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.GAMBLING;
                } else if (/kids|child|toy|cartoon|disney/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.CHILDREN;
                } else if (/game|play|minecraft|roblox/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.GAMES;
                } else if (/news|times|post|journal|daily|cnn|bbc/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.NEWS;
                } else if (/edu|learn|school|academy|course/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.EDUCATION;
                } else if (/shop|store|buy|amazon|ebay/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.LIFESTYLE;
                } else if (/date|dating|adult|xxx/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.ADULT;
                } else if (/crypto|bitcoin|blockchain/i.test(lowerUrl)) {
                    category = PLACEMENT_CATEGORIES.CRYPTO;
                } else if (type.toLowerCase() === 'mobile application') {
                    category = PLACEMENT_CATEGORIES.GAMES;
                }
                
                // Quality scoring
                let qualityScore = 50;
                if (impressions === 0 || (impressions < 10 && clicks === 0)) {
                    qualityScore = 10;
                } else if (ctr < 0.05 && impressions > 100) {
                    qualityScore = 20;
                } else if (conversions > 0) {
                    qualityScore = 70 + Math.min(20, convRate * 4);
                } else if (ctr > 1) {
                    qualityScore = 50;
                } else if (ctr > 0.5) {
                    qualityScore = 40;
                } else {
                    qualityScore = 30;
                }
                
                // Recommendation logic with detailed reasoning
                let recommendation = 'KEEP';
                let reasoning = [];
                
                // Never exclude major platforms
                if (isMajorPlatform) {
                    recommendation = 'REVIEW';
                    reasoning.push(`Major platform (${placementUrl}) - requires individual placement analysis`);
                    if (cost > 100 && conversions === 0) {
                        reasoning.push('High spend with no conversions - review specific placements within this platform');
                    }
                } 
                // High traffic placements get special consideration
                else if (isHighTraffic) {
                    if (category.risk === 'high') {
                        recommendation = 'REVIEW';
                        reasoning.push(`High-traffic ${category.name} placement - manual review recommended`);
                    } else if (conversions === 0 && cost > 50) {
                        recommendation = 'REVIEW';
                        reasoning.push('High traffic with significant spend but no conversions');
                    } else if (qualityScore < 30) {
                        recommendation = 'REVIEW';
                        reasoning.push('High traffic but low quality score - needs investigation');
                    } else {
                        recommendation = 'KEEP';
                        reasoning.push('High traffic with acceptable performance');
                    }
                }
                // Standard placements
                else {
                    if (category.risk === 'high') {
                        recommendation = 'EXCLUDE';
                        reasoning.push(`High-risk category: ${category.name}`);
                    } else if (impressions < 10 && clicks === 0) {
                        recommendation = 'EXCLUDE';
                        reasoning.push('Insufficient data - less than 10 impressions with no clicks');
                    } else if (cost > 10 && conversions === 0) {
                        recommendation = 'EXCLUDE';
                        reasoning.push(`Spent $${cost.toFixed(2)} with zero conversions`);
                    } else if (ctr < 0.1 && impressions > 100) {
                        recommendation = 'EXCLUDE';
                        reasoning.push(`Very low CTR (${ctr.toFixed(2)}%) despite ${impressions} impressions`);
                    } else if (qualityScore >= 60) {
                        recommendation = 'KEEP';
                        reasoning.push('Good performance metrics');
                    } else if (qualityScore >= 40) {
                        recommendation = 'REVIEW';
                        reasoning.push('Moderate performance - review for optimization opportunities');
                    } else {
                        recommendation = 'EXCLUDE';
                        reasoning.push('Poor overall performance');
                    }
                }
                
                return {
                    placement,
                    placementUrl,
                    type,
                    category: category.name,
                    impressions,
                    clicks,
                    conversions,
                    cost,
                    ctr: ctr.toFixed(2),
                    convRate: convRate.toFixed(2),
                    cpa: cpa === 0 ? '0.00' : cpa.toFixed(2),
                    qualityScore,
                    recommendation,
                    reasoning: reasoning.join('; '),
                    isMajorPlatform,
                    isHighTraffic
                };
            };

            const handleFileUpload = useCallback(async (event) => {
                const uploadedFile = event.target.files[0];
                if (!uploadedFile) return;

                setFile(uploadedFile);
                setError(null);
                setLoading(true);
                setAnalysis(null);

                try {
                    const text = await uploadedFile.text();
                    
                    // Parse the CSV
                    const lines = text.split(/\r?\n/);
                    let headerRowIndex = -1;
                    let actualHeaders = [];
                    
                    // Find headers
                    for (let i = 0; i < lines.length && i < 20; i++) {
                        const line = lines[i];
                        if (line.toLowerCase().includes('placement') && line.includes('\t')) {
                            const potentialHeaders = line.split('\t').map(h => h.trim());
                            if (potentialHeaders.length > 5) {
                                headerRowIndex = i;
                                actualHeaders = potentialHeaders;
                                break;
                            }
                        }
                    }
                    
                    if (headerRowIndex === -1) {
                        throw new Error('Could not find column headers. Please check your CSV format.');
                    }
                    
                    // Parse data rows
                    const dataRows = [];
                    for (let i = headerRowIndex + 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line && line !== '--') {
                            const values = line.split('\t');
                            
                            if (values.length === actualHeaders.length) {
                                const row = {};
                                actualHeaders.forEach((header, index) => {
                                    row[header] = values[index] || '';
                                });
                                
                                // Skip total rows
                                if (!row['Placement'] || row['Placement'] === '--' || 
                                    row['Placement'].toLowerCase().includes('total')) {
                                    continue;
                                }
                                
                                dataRows.push(row);
                            }
                        }
                    }
                    
                    if (dataRows.length === 0) {
                        throw new Error('No data rows found in the file');
                    }
                    
                    // Analyze data
                    const results = dataRows.map(row => analyzePlacement(row));
                    
                    // Calculate summary
                    const summary = {
                        total: results.length,
                        toExclude: results.filter(r => r.recommendation === 'EXCLUDE').length,
                        toReview: results.filter(r => r.recommendation === 'REVIEW').length,
                        toKeep: results.filter(r => r.recommendation === 'KEEP').length,
                        totalCost: results.reduce((sum, r) => sum + r.cost, 0),
                        totalConversions: results.reduce((sum, r) => sum + r.conversions, 0),
                        potentialSavings: results.filter(r => r.recommendation === 'EXCLUDE')
                            .reduce((sum, r) => sum + r.cost, 0)
                    };
                    
                    setAnalysis({ results, summary });
                    setLoading(false);
                    
                } catch (err) {
                    console.error('Error:', err);
                    setError(err.message);
                    setLoading(false);
                }
            }, []);

            const downloadAnalysis = useCallback(() => {
                if (!analysis) return;

// Create properly formatted CSV with quoted fields
let csvContent = 'Placement,URL,Type,Category,Impressions,Clicks,CTR%,Conversions,Conv Rate%,Cost,CPA,Quality Score,Recommendation,Reasoning\n';

analysis.results.forEach(r => {
    const row = [
        `"${r.placement.replace(/"/g, '""')}"`,
        `"${r.placementUrl.replace(/"/g, '""')}"`,
        `"${r.type.replace(/"/g, '""')}"`,
        r.category,
        r.impressions,
        r.clicks,
        r.ctr,
        r.conversions,
        r.convRate,
        r.cost.toFixed(2),
        r.cpa,
        r.qualityScore,
        r.recommendation,
        `"${r.reasoning.replace(/"/g, '""')}"`
    ];
    csvContent += row.join(',') + '\n';
})
   
               
                // Add summary
                csvContent += '\n\nSummary|||||||||||||||\n';
                csvContent += `Total Placements|${analysis.summary.total}||||||||||||||\n`;
                csvContent += `Recommended for Exclusion|${analysis.summary.toExclude}||||||||||||||\n`;
                csvContent += `Needs Review|${analysis.summary.toReview}||||||||||||||\n`;
                csvContent += `Keep Active|${analysis.summary.toKeep}||||||||||||||\n`;
                csvContent += `Total Cost|$${analysis.summary.totalCost.toFixed(2)}||||||||||||||\n`;
                csvContent += `Potential Savings|$${analysis.summary.potentialSavings.toFixed(2)}||||||||||||||\n`;

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `placement_analysis_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }, [analysis]);

            return (
                <div className="min-h-screen bg-gray-50 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                GGuardrails Ads Placement Analyzer
                            </h1>
                            <p className="text-gray-600 mb-8">
                                Upload your placement report to identify and exclude low-quality placements
                            </p>

                            {/* File Upload */}
                            <div className="mb-8">
                                <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg className="w-10 h-10 mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <p className="mb-2 text-sm text-gray-500">
                                            <span className="font-semibold">Click to upload</span> or drag and drop
                                        </p>
                                        <p className="text-xs text-gray-500">CSV files from Google Ads</p>
                                    </div>
                                    <input type="file" className="hidden" accept=".csv" onChange={handleFileUpload} />
                                </label>
                                {file && (
                                    <p className="mt-2 text-sm text-gray-600">
                                        Selected: {file.name}
                                    </p>
                                )}
                            </div>

                            {/* Error Display */}
                            {error && (
                                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <p className="text-red-800">{error}</p>
                                </div>
                            )}

                            {/* Loading State */}
                            {loading && (
                                <div className="flex flex-col items-center justify-center py-12">
                                    <div className="loader loader-spin w-12 h-12 border-4 border-gray-300 rounded-full mb-4"></div>
                                    <p className="text-gray-600">Analyzing placements...</p>
                                </div>
                            )}

                            {/* Analysis Results */}
                            {analysis && !loading && (
                                <div className="space-y-6">
                                    {/* Summary Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                                        <div className="bg-blue-50 p-4 rounded-lg">
                                            <h3 className="text-lg font-semibold text-blue-900">Total Placements</h3>
                                            <p className="text-2xl font-bold text-blue-600">{analysis.summary.total}</p>
                                        </div>
                                        <div className="bg-red-50 p-4 rounded-lg">
                                            <h3 className="text-lg font-semibold text-red-900">To Exclude</h3>
                                            <p className="text-2xl font-bold text-red-600">{analysis.summary.toExclude}</p>
                                        </div>
                                        <div className="bg-yellow-50 p-4 rounded-lg">
                                            <h3 className="text-lg font-semibold text-yellow-900">To Review</h3>
                                            <p className="text-2xl font-bold text-yellow-600">{analysis.summary.toReview}</p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg">
                                            <h3 className="text-lg font-semibold text-green-900">To Keep</h3>
                                            <p className="text-2xl font-bold text-green-600">{analysis.summary.toKeep}</p>
                                        </div>
                                    </div>

                                    {/* Key Metrics */}
                                    <div className="bg-gray-50 p-6 rounded-lg">
                                        <h3 className="text-lg font-semibold mb-4">Campaign Overview</h3>
                                        <div className="grid grid-cols-3 gap-4 text-center">
                                            <div>
                                                <p className="text-gray-600">Total Spend</p>
                                                <p className="text-xl font-bold">${analysis.summary.totalCost.toFixed(2)}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">Total Conversions</p>
                                                <p className="text-xl font-bold">{analysis.summary.totalConversions}</p>
                                            </div>
                                            <div>
                                                <p className="text-gray-600">Potential Savings</p>
                                                <p className="text-xl font-bold text-red-600">${analysis.summary.potentialSavings.toFixed(2)}</p>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Important Notes */}
                                    <div className="bg-yellow-50 p-4 rounded-lg">
                                        <h4 className="font-semibold text-yellow-900 mb-2">Important Notes:</h4>
                                        <ul className="text-sm text-yellow-800 space-y-1">
                                            <li>• Major platforms (YouTube, Gmail, etc.) are marked for REVIEW, not automatic exclusion</li>
                                            <li>• High-traffic placements receive special consideration</li>
                                            <li>• Review recommendations require manual evaluation based on your campaign goals</li>
                                            <li>• The analysis includes detailed reasoning for each recommendation</li>
                                        </ul>
                                    </div>

                                    {/* Download Button */}
                                    <div className="flex justify-center">
                                        <button
                                            onClick={downloadAnalysis}
                                            className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg"
                                        >
                                            Download Full Analysis (CSV)
                                        </button>
                                    </div>

                                    {/* Sample Results Table */}
                                    <div className="mt-8">
                                        <h3 className="text-lg font-semibold mb-4">Sample Results (First 10)</h3>
                                        <div className="overflow-x-auto">
                                            <table className="min-w-full divide-y divide-gray-200">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placement</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quality</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommendation</th>
                                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reasoning</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white divide-y divide-gray-200">
                                                    {analysis.results.slice(0, 10).map((result, index) => (
                                                        <tr key={index}>
                                                            <td className="px-6 py-4 text-sm text-gray-900">
                                                                <div>
                                                                    <div className="font-medium">{result.placement}</div>
                                                                    <div className="text-xs text-gray-500">{result.placementUrl}</div>
                                                                    {result.isMajorPlatform && (
                                                                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded mt-1 inline-block">
                                                                            Major Platform
                                                                        </span>
                                                                    )}
                                                                    {result.isHighTraffic && (
                                                                        <span className="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded mt-1 inline-block ml-1">
                                                                            High Traffic
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-500">
                                                                {result.category}
                                                            </td>
                                                            <td className="px-6 py-4 text-sm text-gray-500">
                                                                <div className="flex items-center">
                                                                    <div className="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                                        <div
                                                                            className={`h-2 rounded-full ${
                                                                                result.qualityScore >= 70 ? 'bg-green-500' :
                                                                                result.qualityScore >= 40 ? 'bg-yellow-500' : 'bg-red-500'
                                                                            }`}
                                                                            style={{ width: `${result.qualityScore}%` }}
                                                                        />
                                                                    </div>
                                                                    <span>{result.qualityScore}/100</span>
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4">
                                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                                    result.recommendation === 'EXCLUDE' ? 'bg-red-100 text-red-800' :
                                                                    result.recommendation === 'REVIEW' ? 'bg-yellow-100 text-yellow-800' :
                                                                    'bg-green-100 text-green-800'
                                                                }`}>
                                                                    {result.recommendation}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 text-xs text-gray-600 max-w-xs">
                                                                {result.reasoning}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<PlacementAnalyzer />, document.getElementById('root'));
    </script>
</body>
</html>
